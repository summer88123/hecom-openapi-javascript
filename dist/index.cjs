"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const u=require("axios"),S=require("base-64");class h extends Error{constructor(e){super(e),this.name="HecomError"}}class p extends h{constructor(e,t,r){super(e),this.name="NetHecomError",this.statusCode=t,this.url=r}}class l extends h{constructor(e,t,r){super(e),this.name="BizHecomError",this.code=t,this.data=r}}class q{constructor(e){this.refreshToken=null,this.expiresIn=0,this.verifyConfig(e),this.authConfig=e}verifyConfig(e){if(!e)throw new Error("配置不能为空");if(!e.clientId||!e.clientSecret)throw new Error("clientId和clientSecret不能为空");if(!e.username)throw new Error("username不能为空");e.apiHost||(e.apiHost="https://tc.cloud.hecom.cn")}async getAccessToken(){if(this.accessToken&&Date.now()<this.expiresIn)return this.accessToken;const e=`${this.authConfig.apiHost}/hecom-tenancy/oauth/token`,t=`Basic ${S.encode(`${this.authConfig.clientId}:${this.authConfig.clientSecret}`)}`,r=this.accessToken?{grant_type:"refresh_token",refresh_token:this.refreshToken||this.accessToken}:{grant_type:"client_credentials",username:this.authConfig.username};console.log(e);const s=await u.post(e,r,{headers:{"Content-Type":"application/json",Authorization:t}});return this.accessToken=s.data.access_token,this.refreshToken=s.data.refresh_token,this.expiresIn=Date.now()+s.data.expires_in*1e3,this.endPoint=s.data.endPoint,this.accessToken||""}getEndPoint(){return this.endPoint}async request(e,t,r){const n={Authorization:`Bearer ${await this.getAccessToken()}`,"Content-Type":"application/json"};try{const{data:c}=await u.request({method:e,url:t,data:r,headers:n,baseURL:this.getEndPoint()});if(c.result==="0")return c.data;throw new l(c.desc,c)}catch(c){if(u.isAxiosError(c)){const o=c;throw new p(o.response.data.desc,o.response.data.code,t)}else throw c}}}class D{constructor(e){this.authService=e}async request(e,t,r){return this.authService.request(e,t,r)}async getConstantGroups(){return this.request("GET","/v1/data/constantgroups")}async getConstantOptions(e){return this.request("GET",`/v1/data/constantgroups/${e}/constants`)}async createConstantOption(e,t,r,s){return this.request("POST",`/v1/data/constantgroups/${e}/constants`,{name:t,label:r,parentName:s})}async updateConstantOption(e,t,r){return this.request("PATCH",`/v1/data/constantgroups/${e}/constants/${t}`,{label:r})}}function i(a,e){let{selectFields:t,pageNo:r,pageSize:s,query:n}=e,c=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"/v1/data/objects",o=arguments.length>3&&arguments[3]!==void 0?arguments[3]:10;const y=n?Object.keys(n).reduce((v,d)=>`&${v}${d}=${n[d]}`,""):"",g=Array.isArray(t)&&t.length>0?t.join(","):"code,name";return`${c}/${a}?selectFields=${g}&pageNo=${r||1}&pageSize=${s||o}${y}`}class f{constructor(e){this.authService=e}async request(e,t,r){return this.authService.request(e,t,r)}countTreeRecords(e){let t=0;for(const r of e)if(r.records&&Array.isArray(r.records)){t+=r.records.length;for(const s of r.records)s.treeRelateds&&Array.isArray(s.treeRelateds)&&(t+=this.countTreeRecords(s.treeRelateds))}return t}async createData(e,t){return this.request("POST",`/v1/data/objects/${e}`,t)}async createDataWithRelated(e,t){const r=t.related?t.related.data.length:0,s=t.treeRelated?this.countTreeRecords(t.treeRelated.data):0,n=r+s;if(n>29)throw new Error(`关联子对象数据总数最多29条（主+子限制30条），当前关联子对象${r}条，树形子对象${s}条，总计${n}条`);return this.request("POST",`/v1/data/objects-with-related/${e}`,t)}async updateData(e,t,r){return this.request("PATCH",`/v1/data/objects/${e}/${t}`,r)}async batchCreateData(e,t){if(t.length>30)throw new Error("批量新增业务数据最多30条");if(t.length===0)throw new Error("批量新增业务数据不能为空");return this.request("POST",`/oapi/v1/data/objects/${e}/batch`,{records:t})}async deleteData(e,t){return this.request("DELETE",`/v1/data/objects/${e}/${t}`)}async batchUpdateData(e,t){if(t.length>30)throw new Error("批量更新业务数据最多30条");if(t.length===0)throw new Error("批量更新业务数据不能为空");if(t.some(r=>!r.code))throw new Error("批量更新业务数据必须包含code字段");return this.request("PATCH",`/oapi/v1/data/objects/${e}/batch`,{records:t})}async getData(e,t){return this.request("GET",`/v1/data/objects/${e}/${t}`)}async queryData(e,t){const r=i(e,t);return this.request("GET",r)}async queryDataBySQL(e){const r=`/v1/data/query?sql=${encodeURIComponent(e)}`;return this.request("GET",r)}async queryAuxiliaryData(e,t){const r=i(e,t,"/v1/data/objects/listAuxiliaryBizData");return this.request("GET",r)}async transferOwner(e,t,r,s,n){if(!t)throw new Error("数据code不能为空");if(!r)throw new Error("新负责人code不能为空");return this.request("PATCH",`/oapi/v1/data/${e}/${t}/tansferOwner`,{newOwner:r,addTeam:s?1:0,deptFollowNewOwner:n?1:0})}}class T{constructor(e){this.authService=e}async request(e,t,r){return this.authService.request(e,t,r)}async getDeptDescription(){return this.request("GET","/v1/data/app/orgconfig/objects/Org/description")}async createDept(e){return this.request("POST","/v1/data/app/orgconfig/objects/Org",e)}async updateDept(e,t){return this.request("PATCH",`/v1/data/app/orgconfig/objects/Org/${e}`,t)}async getDeptDetail(e){return this.request("GET",`/v1/data/app/orgconfig/objects/Org/${e}`)}async queryDepts(e){const t=i("Org",e,"/v1/data/app/orgconfig/objects");return this.request("GET",t)}async queryDeptsBySQL(e){const r=`/v1/data/app/orgconfig/query?sql=${encodeURIComponent(e)}`;return this.request("GET",r)}async disableDept(e,t){return this.request("PATCH",`/v1/data/app/orgconfig/objects/Org/disableOrg/${e}`,{moveToDeptCode:t})}async enableDept(e){return this.request("PATCH",`/v1/data/app/orgconfig/objects/Org/enableOrg/${e}`)}async changeDeptParent(e,t){return this.request("POST",`/v1/data/app/orgconfig/objects/Org/changeOrgDept/${e}`,{dept:t})}}class b{constructor(e){this.authService=e}async request(e,t,r){return this.authService.request(e,t,r)}async getObjects(){return this.request("GET","/v1/data/objects")}async getObjectDescription(e){return this.request("GET",`/v1/data/objects/${e}/description`)}}class ${constructor(e){this.authService=e}async request(e,t,r){return this.authService.request(e,t,r)}async getRoleDescription(){return this.request("GET","/v1/data/app/roleconfig/objects/Role/description")}async createRole(e){return this.request("POST","/v1/data/app/roleconfig/objects/Role",e)}async updateRole(e,t){return this.request("PATCH",`/v1/data/app/roleconfig/objects/Role/${e}`,t)}async getRoleDetail(e){return this.request("GET",`/v1/data/app/roleconfig/objects/Role/${e}`)}async queryRoles(e){const t=i("Role",e,"/v1/data/app/roleconfig/objects");return this.request("GET",t)}async queryRolesBySQL(e){const r=`/v1/data/app/roleconfig/query?sql=${encodeURIComponent(e)}`;return this.request("GET",r)}}class E{constructor(e){this.authService=e}async request(e,t,r){return this.authService.request(e,t,r)}async getUserDescription(){return this.request("GET","/v1/data/app/userconfig/objects/User/description")}async createUser(e){return this.request("POST","/v1/data/app/userconfig/objects/User",e)}async updateUser(e,t){return this.request("PATCH",`/v1/data/app/userconfig/objects/User/${e}`,t)}async getUserDetail(e){return this.request("GET",`/v1/data/app/userconfig/objects/User/${e}`)}async queryUsers(e){const t=i("User",e,"/v1/data/app/userconfig/objects");return this.request("GET",t)}async freezeUser(e){return this.request("POST",`/v1/data/app/userconfig/freeze/${e}`)}async unfreezeUser(e){return this.request("POST",`/v1/data/app/userconfig/unfreeze/${e}`)}async dimissionUser(e){return this.request("POST",`/v1/data/app/userconfig/dimission/${e}`)}async resumeUser(e,t,r){return this.request("POST",`/v1/data/app/userconfig/resume/${e}`,{dept:t,phone:r})}async assignRoles(e,t){return this.request("POST",`/v1/data/app/userconfig/assignRoles/${e}`,{roles:t})}async queryUsersBySQL(e){const r=`/v1/data/app/userconfig/query?sql=${encodeURIComponent(e)}`;return this.request("GET",r)}async transferUserDept(e,t,r,s){return this.request("POST",`/v1/data/app/userconfig/transferUserDept/${e}`,{oldDeptCode:t,newDeptCode:r,transferData:s})}}class O{constructor(e){this.config={pageSize:10},this.authService=new q(e),this.objectService=new b(this.authService),this.dataService=new f(this.authService),this.userService=new E(this.authService),this.deptService=new T(this.authService),this.roleService=new $(this.authService),this.constantGroupService=new D(this.authService)}async getObjects(){return this.objectService.getObjects()}async getObjectDescription(e){return this.objectService.getObjectDescription(e)}async createData(e,t){return this.dataService.createData(e,t)}async createDataWithRelated(e,t,r,s){return this.dataService.createDataWithRelated(e,{data:t,related:r,treeRelated:s})}async updateData(e,t,r){return this.dataService.updateData(e,t,r)}async batchCreateData(e,t){return this.dataService.batchCreateData(e,t)}async deleteData(e,t){return this.dataService.deleteData(e,t)}async batchUpdateData(e,t){return this.dataService.batchUpdateData(e,t)}async getData(e,t){return this.dataService.getData(e,t)}async queryData(e,t){return this.dataService.queryData(e,t)}async queryDataBySQL(e){return this.dataService.queryDataBySQL(e)}async queryAuxiliaryData(e,t){return this.dataService.queryAuxiliaryData(e,t)}async transferOwner(e,t,r,s,n){return this.dataService.transferOwner(e,t,r,s,n)}async getUserDescription(){return this.userService.getUserDescription()}async createUser(e){return this.userService.createUser(e)}async updateUser(e,t){return this.userService.updateUser(e,t)}async getUserDetail(e){return this.userService.getUserDetail(e)}async getDeptDescription(){return this.deptService.getDeptDescription()}async createDept(e){return this.deptService.createDept(e)}async updateDept(e,t){return this.deptService.updateDept(e,t)}async getDeptDetail(e){return this.deptService.getDeptDetail(e)}async queryDeptsBySQL(e){return this.deptService.queryDeptsBySQL(e)}async getRoleDescription(){return this.roleService.getRoleDescription()}async createRole(e){return this.roleService.createRole(e)}async updateRole(e,t){return this.roleService.updateRole(e,t)}async getRoleDetail(e){return this.roleService.getRoleDetail(e)}async getConstantGroups(){return this.constantGroupService.getConstantGroups()}async getConstantOptions(e){return this.constantGroupService.getConstantOptions(e)}async createConstantOption(e,t,r,s){return this.constantGroupService.createConstantOption(e,t,r,s)}async updateConstantOption(e,t,r){return this.constantGroupService.updateConstantOption(e,t,r)}}exports.BizHecomError=l;exports.HecomError=h;exports.NetHecomError=p;exports.default=O;
